<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Invoice & Quotation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');
        
        :root { font-family: 'Inter', sans-serif; }
        
        /* Font Style Classes */
        .font-modern { font-family: 'Inter', sans-serif; }
        .font-classic { font-family: 'Playfair Display', serif; }
        .font-tech { font-family: 'Roboto Mono', monospace; }
        .font-ui { font-family: 'Montserrat', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Rich Text Formatting in Preview */
        .rich-content ul { list-style-type: disc; margin-left: 1.2em; }
        .rich-content ol { list-style-type: decimal; margin-left: 1.2em; }
        .rich-content b { font-weight: 700; }

        /* --- PRINT & PDF ENGINE --- */
        @page {
            size: A4;
            margin: 0;
        }

        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            #app-container { display: block !important; padding: 0 !important; margin: 0 !important; }
            #editor-pane { display: none !important; }
            #preview-pane { width: 100% !important; padding: 0 !important; height: auto !important; overflow: visible !important; display: block !important; }
            #document-preview { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 210mm !important; 
                min-height: 297mm !important;
                border: none !important;
                transform: none !important;
                padding: 12mm !important;
            }
            .page-break-avoid { page-break-inside: avoid; break-inside: avoid; }
        }

        body.generating-pdf .no-print { display: none !important; }
        body.generating-pdf #editor-pane { display: none !important; }
        body.generating-pdf #preview-pane { width: 100% !important; padding: 0 !important; display: block !important; }
        body.generating-pdf #document-preview { 
            box-shadow: none !important; 
            margin: 0 !important; 
            width: 210mm !important;
            padding: 15mm !important;
            transform: none !important;
        }

        /* Screen Preview Rendering */
        #document-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            transform-origin: top center;
            padding: 12mm;
            display: flex;
            flex-direction: column;
        }

        .gradient-accent { transition: all 0.4s ease; }
        .theme-accent-text { transition: color 0.3s; }

        @media (max-width: 1400px) {
            #preview-pane { overflow-x: auto; }
        }

        .rich-text-editor { min-height: 40px; outline: none; }
    </style>
</head>
<body class="bg-slate-200 min-h-screen text-slate-800">
    <div id="app-container" class="flex flex-col lg:flex-row h-screen overflow-hidden">
        
        <!-- LEFT SIDE: THE EDITOR -->
        <div id="editor-pane" class="no-print lg:w-[500px] flex-shrink-0 bg-white border-r border-slate-200 flex flex-col h-full shadow-2xl z-30">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white font-bold text-xl">M</div>
                    <div>
                        <h1 class="font-bold text-slate-900 leading-tight">Master Invoice</h1>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Cloud Edition</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="user-name" class="text-xs text-slate-500 hidden"></span>
                    <div id="auth-indicator" class="w-2.5 h-2.5 rounded-full bg-red-400 shadow-sm" title="Cloud Sync Offline"></div>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-6 space-y-10 custom-scrollbar pb-32">
                
                <!-- 1. Appearance & Presets -->
                <section class="space-y-4">
                    <label class="text-[11px] font-extrabold text-slate-500 uppercase tracking-widest block">Design System</label>
                    <div class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="text-[10px] text-slate-400 uppercase font-bold block mb-3">Color Template (Gradients)</span>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #1e293b 0%, #334155 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-slate-700" title="Professional Slate"></button>
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-orange-500" title="AKEF Orange"></button>
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #2563eb 0%, #1e40af 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-blue-600" title="Business Blue"></button>
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #059669 0%, #064e3b 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-emerald-600" title="Modern Emerald"></button>
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #db2777 0%, #831843 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-pink-600" title="Elegant Rose"></button>
                                <button onclick="updateDesign('color', 'linear-gradient(135deg, #4f46e5 0%, #312e81 100%)')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-indigo-600" title="Midnight Indigo"></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="updateDesign('font', 'font-modern')" class="py-2 px-3 border border-slate-200 rounded-lg text-xs font-semibold hover:bg-slate-50">Modern Sans</button>
                            <button onclick="updateDesign('font', 'font-classic')" class="py-2 px-3 border border-slate-200 rounded-lg text-xs font-semibold hover:bg-slate-50 font-serif">Classic Serif</button>
                            <button onclick="updateDesign('font', 'font-tech')" class="py-2 px-3 border border-slate-200 rounded-lg text-xs font-semibold hover:bg-slate-50 font-mono">Technical Mono</button>
                            <button onclick="updateDesign('font', 'font-ui')" class="py-2 px-3 border border-slate-200 rounded-lg text-xs font-semibold hover:bg-slate-50">UI Montserrat</button>
                        </div>
                    </div>
                </section>

                <!-- 2. Document Identity -->
                <section class="space-y-4">
                    <label class="text-[11px] font-extrabold text-slate-500 uppercase tracking-widest block">Document Info</label>
                    <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-xl">
                        <button onclick="setDocType('INVOICE')" id="btn-invoice" class="py-2.5 text-xs font-bold rounded-lg transition-all">Invoice</button>
                        <button onclick="setDocType('QUOTATION')" id="btn-quote" class="py-2.5 text-xs font-bold rounded-lg transition-all">Quotation</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Document No.</span>
                            <input type="text" id="document-id" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold" oninput="updateField('docId', this.value)">
                        </div>
                        <div class="space-y-1">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Date</span>
                            <input type="date" id="input-date" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium" onchange="updateField('date', this.value)">
                        </div>
                    </div>
                </section>

                <!-- 3. Bill From -->
                <section class="space-y-4 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative">
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-extrabold text-slate-900 uppercase tracking-widest block">Bill From (Your Business)</label>
                        <button onclick="saveProfile('from')" class="text-[9px] bg-slate-100 text-slate-600 px-2 py-1 rounded hover:bg-slate-200 font-bold">Save as Default</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="from-name" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold" placeholder="Company Name" oninput="updateField('from.name', this.value)">
                        <textarea id="from-address" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="Full Address, Contact No, Email" oninput="updateField('from.address', this.value)"></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="from-gst" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-[10px]" placeholder="GSTIN" oninput="updateField('from.gst', this.value)">
                            <input type="text" id="from-pan" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-[10px]" placeholder="PAN" oninput="updateField('from.pan', this.value)">
                        </div>
                    </div>
                </section>

                <!-- 4. Bill To -->
                <section class="space-y-4 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative">
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-extrabold text-slate-900 uppercase tracking-widest block">Bill To (Client)</label>
                        <button onclick="saveProfile('client')" class="text-[9px] bg-slate-100 text-slate-600 px-2 py-1 rounded hover:bg-slate-200 font-bold">Remember Client</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="client-name" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold" placeholder="Client Name / Business" oninput="updateField('client.name', this.value)">
                        <textarea id="client-address" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="Client Address, Email, Phone" oninput="updateField('client.address', this.value)"></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="client-gst" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-[10px]" placeholder="Client GSTIN" oninput="updateField('client.gst', this.value)">
                            <input type="text" id="client-pan" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-[10px]" placeholder="Client PAN" oninput="updateField('client.pan', this.value)">
                        </div>
                    </div>
                </section>

                <!-- 5. Line Items -->
                <section class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-extrabold text-slate-500 uppercase tracking-widest">Inventory / Services</label>
                        <button onclick="addItem()" class="text-[10px] bg-slate-900 text-white px-4 py-1.5 rounded-full font-bold shadow-md">+ New Line</button>
                    </div>
                    <div id="editor-items-list" class="space-y-4"></div>
                </section>

                <!-- 6. Bank Details -->
                <section class="space-y-4 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative">
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-extrabold text-slate-900 uppercase tracking-widest block">Payment Details</label>
                        <button onclick="saveProfile('bank')" class="text-[9px] bg-slate-100 text-slate-600 px-2 py-1 rounded hover:bg-slate-200 font-bold">Save Account</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="bank-name" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="Bank Name" oninput="updateField('bank.bankName', this.value)">
                        <input type="text" id="bank-acc" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="A/C Number" oninput="updateField('bank.accountNo', this.value)">
                        <input type="text" id="bank-ifsc" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="IFSC Code" oninput="updateField('bank.ifsc', this.value)">
                        <input type="text" id="bank-branch" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs" placeholder="Branch Name" oninput="updateField('bank.branch', this.value)">
                    </div>
                </section>

                <!-- 7. Branding & Signature -->
                <section class="space-y-6 bg-slate-900 p-6 rounded-2xl text-white">
                    <label class="text-[10px] font-bold uppercase tracking-[.2em] block opacity-50">Assets & Branding</label>
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <span class="text-xs font-bold block">Company Logo</span>
                            <p class="text-[9px] opacity-60">High res PNG recommended</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('logo-upload').click()" class="text-[9px] bg-white text-slate-900 px-3 py-1.5 rounded-full font-bold">Upload</button>
                            <button onclick="removeImage('logo')" id="btn-remove-logo" class="hidden text-[9px] bg-red-500 text-white px-3 py-1.5 rounded-full font-bold">Remove</button>
                        </div>
                        <input type="file" id="logo-upload" class="hidden" accept="image/*" onchange="handleImageUpload(this, 'logo')">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 flex justify-between mb-2">Logo Display Size <span id="lbl-logo-size">100%</span></label>
                        <input type="range" min="30" max="150" value="100" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="updateImageSize('logo', this.value)">
                    </div>
                    <hr class="border-slate-800">
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <span class="text-xs font-bold block">Digital Signature</span>
                            <p class="text-[9px] opacity-60">Transparent background</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('sig-upload').click()" class="text-[9px] bg-white text-slate-900 px-3 py-1.5 rounded-full font-bold">Upload</button>
                            <button onclick="removeImage('sig')" id="btn-remove-sig" class="hidden text-[9px] bg-red-500 text-white px-3 py-1.5 rounded-full font-bold">Remove</button>
                        </div>
                        <input type="file" id="sig-upload" class="hidden" accept="image/*" onchange="handleImageUpload(this, 'sig')">
                    </div>
                </section>
                
                <!-- History -->
                <section>
                    <label class="text-[11px] font-extrabold text-slate-500 uppercase tracking-widest block mb-3">Cloud Archive</label>
                    <ul id="history-list" class="space-y-2"></ul>
                </section>
            </div>

            <!-- Editor Footer -->
            <div class="p-6 border-t border-slate-100 bg-white grid grid-cols-2 gap-3 absolute bottom-0 left-0 right-0 z-40 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
                <button onclick="saveDocument()" class="bg-slate-900 text-white py-3 rounded-2xl text-sm font-bold shadow-lg hover:shadow-slate-200 transition-all active:scale-95">Save Document</button>
                <button onclick="resetDocument()" class="bg-slate-100 text-slate-600 py-3 rounded-2xl text-sm font-bold hover:bg-slate-200 transition-all active:scale-95">Start New</button>
            </div>
        </div>

        <!-- RIGHT SIDE: LIVE A4 PREVIEW -->
        <div id="preview-pane" class="flex-grow bg-slate-300 overflow-y-auto p-4 lg:p-12 h-full flex justify-center custom-scrollbar relative">
            
            <div id="document-preview" class="document-container shadow-2xl relative transition-all duration-300 transform-gpu lg:scale-90 xl:scale-100 origin-top">
                
                <!-- HEADER -->
                <div class="relative border-b border-slate-100 header-bg">
                    <div class="absolute inset-0 overflow-hidden pointer-events-none">
                        <div id="p-header-circle" class="absolute -top-10 -right-10 w-48 h-48 rounded-full opacity-10 gradient-accent"></div>
                    </div>

                    <div class="p-12 pb-10 relative z-20">
                        <div class="flex justify-between items-start">
                            <!-- Logo Area -->
                            <div class="w-1/2 flex items-start gap-6">
                                <div id="p-logo-container" class="w-20 h-20 rounded-2xl flex items-center justify-center overflow-hidden bg-slate-50 border border-slate-100 relative">
                                    <img id="p-logo-img" src="" class="hidden w-full h-full object-contain">
                                    <span id="p-logo-placeholder" class="text-xl font-black text-slate-300">LOGO</span>
                                </div>
                                <div>
                                    <h1 id="p-from-name" class="text-2xl font-black text-slate-900 tracking-tighter leading-none mb-3 uppercase">Your Business</h1>
                                    <div class="text-[11px] text-slate-500 space-y-1 font-medium leading-relaxed">
                                        <div id="p-from-address" class="whitespace-pre-wrap max-w-xs">Business Address Details</div>
                                        <div class="flex gap-4 mt-2">
                                            <p>GSTIN: <span id="p-from-gst" class="text-slate-800 font-bold"></span></p>
                                            <p>PAN: <span id="p-from-pan" class="text-slate-800 font-bold"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Meta -->
                            <div class="w-1/2 text-right">
                                <h2 id="p-doc-title" class="text-6xl font-black tracking-tighter text-slate-900 mb-8 uppercase theme-accent-text">INVOICE</h2>
                                <div class="space-y-2 text-[11px]">
                                    <div class="flex justify-end gap-6"><span class="font-bold text-slate-400 uppercase tracking-widest">Doc Number</span><span id="p-doc-id" class="font-mono font-bold text-slate-900 text-sm"></span></div>
                                    <div class="flex justify-end gap-6"><span class="font-bold text-slate-400 uppercase tracking-widest">Date</span><span id="p-date" class="font-bold text-slate-900 text-sm"></span></div>
                                    <div class="flex justify-end gap-6"><span class="font-bold text-slate-400 uppercase tracking-widest">Due Date</span><span id="p-due-date" class="font-medium text-slate-500 text-sm"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CLIENT INFO -->
                <div class="p-12 py-10 grid grid-cols-2 gap-12 relative border-b border-slate-50">
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest mb-4 theme-accent-text">Bill To</p>
                        <h3 id="p-client-name" class="text-lg font-bold text-slate-900 mb-2 uppercase">Client Name</h3>
                        <div id="p-client-address" class="text-xs text-slate-500 leading-relaxed whitespace-pre-wrap mb-4">Client Contact & Address</div>
                        <div class="text-[10px] space-y-1 font-bold text-slate-400">
                            <p>GSTIN: <span id="p-client-gst" class="text-slate-700"></span></p>
                            <p>PAN: <span id="p-client-pan" class="text-slate-700"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ITEMS TABLE -->
                <div class="px-12 flex-grow">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr id="p-table-header" class="text-white text-[10px] font-black uppercase tracking-widest text-left gradient-accent">
                                <th class="py-4 px-6 rounded-l-2xl w-1/2">Item Description</th>
                                <th class="py-4 px-6 text-center">Qty</th>
                                <th class="py-4 px-6 text-right">Rate</th>
                                <th class="py-4 px-6 rounded-r-2xl text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="p-items-body" class="text-sm border-b border-slate-100"></tbody>
                    </table>
                </div>

                <!-- FOOTER -->
                <div class="p-12 mt-auto">
                    <div class="flex justify-between items-start gap-12">
                        <!-- Terms & Bank -->
                        <div class="w-1/2 space-y-8 text-[11px] text-slate-500">
                            <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                                <p class="font-black text-slate-900 uppercase tracking-widest mb-3 flex items-center gap-2 text-[10px]">
                                    <span id="p-bank-icon" class="w-1 h-3.5 rounded-full gradient-accent"></span> Bank Remittance
                                </p>
                                <div id="p-bank-details" class="grid grid-cols-[auto_1fr] gap-x-6 gap-y-1">
                                    <span>Bank:</span> <span id="p-bank-name" class="font-bold text-slate-800 uppercase"></span>
                                    <span>A/C No:</span> <span id="p-bank-acc" class="font-bold text-slate-800"></span>
                                    <span>IFSC:</span> <span id="p-bank-ifsc" class="font-bold text-slate-800 uppercase"></span>
                                    <span>Branch:</span> <span id="p-bank-branch" class="font-bold text-slate-800 uppercase"></span>
                                </div>
                            </div>
                            <div>
                                <p class="font-black text-slate-400 uppercase mb-2 tracking-widest text-[9px]">Amount in Words</p>
                                <p id="p-amount-words" class="font-bold text-slate-900 italic leading-relaxed"></p>
                            </div>
                            <div>
                                <p class="font-black text-slate-400 uppercase mb-2 tracking-widest text-[9px]">Terms & Conditions</p>
                                <div id="p-notes" class="whitespace-pre-wrap leading-relaxed text-[10px] text-slate-400 font-medium"></div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="w-1/2">
                            <div class="bg-slate-50 p-8 rounded-3xl border border-slate-100 space-y-4">
                                <div class="flex justify-between text-slate-500 font-medium"><span>Subtotal</span><span id="p-subtotal" class="font-bold text-slate-900"></span></div>
                                <div class="flex justify-between items-center text-slate-500 font-medium">
                                    <span>Tax Rate (<span id="p-tax-label"></span>%)</span>
                                    <span id="p-tax-amount" class="font-bold text-slate-900"></span>
                                </div>
                                <div class="h-px bg-slate-200 my-2"></div>
                                <div class="flex justify-between items-end">
                                    <span class="text-xs font-black text-slate-900 uppercase tracking-widest">Grand Total</span>
                                    <span id="p-total" class="text-4xl font-black text-slate-900 tracking-tighter"></span>
                                </div>
                            </div>

                            <!-- Authorized Signatory -->
                            <div class="mt-10 text-right flex flex-col items-end">
                                <div class="h-20 flex items-end justify-end mb-2">
                                    <img id="p-sig-img" src="" class="hidden max-h-full object-contain">
                                </div>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[.3em] border-t-2 border-slate-100 pt-3 inline-block min-w-[160px]">Authorized Signatory</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="p-footer-bar" class="h-2.5 w-full mt-4 gradient-accent"></div>
            </div>

            <!-- PDF ACTIONS -->
            <div class="no-print fixed bottom-8 right-8 flex flex-col gap-3 z-50">
                <button onclick="downloadPDF()" class="bg-slate-900 text-white p-5 rounded-full shadow-2xl hover:scale-110 transition-transform active:scale-95 group">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 font-black uppercase tracking-widest whitespace-nowrap text-sm">Download PDF</span>
                    </div>
                </button>
                <button onclick="window.print()" class="bg-white text-slate-900 border border-slate-200 p-5 rounded-full shadow-2xl hover:scale-110 transition-transform active:scale-95 group">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 font-black uppercase tracking-widest whitespace-nowrap text-sm">Print Page</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Suggestions Datalist -->
    <datalist id="item-suggestions">
        <option value="Gaming Equipment Rental">
        <option value="Event Production">
        <option value="Venue Hire">
        <option value="Logistics & Transportation">
        <option value="Software Licensing">
        <option value="Support & Maintenance">
        <option value="Consultancy Services">
        <option value="Hardware Maintenance">
    </datalist>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vhwbyclyxfvbzqmpzswl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZod2J5Y2x5eGZ2YnpxbXB6c3dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3OTQxMzgsImV4cCI6MjA4MjM3MDEzOH0.Py9g67PQhzW29JhsjSTorMn0s-L9wy7Ds1kxBokSWaM';
        
        let supabaseClient = null;
        let userId = null;
        let data = initData();
        let currentId = null;
        let historyDocs = [];

        // Logic Helpers
        function calcDue(d) { 
            if(!d) return '';
            const x = new Date(d); 
            x.setDate(x.getDate() + 7); 
            return x.toISOString().split('T')[0]; 
        }

        function formatDate(d) { 
            if(!d) return ''; 
            return new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-'); 
        }

        function formatMoney(n) { 
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(n); 
        }

        function numToWords(n) {
            if(!n || n <= 0) return 'Zero Rupees Only';
            const units = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
            const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
            const convert = (num) => {
                if(num < 20) return units[num];
                if(num < 100) return tens[Math.floor(num/10)] + (num%10 ? " " + units[num%10] : "");
                if(num < 1000) return units[Math.floor(num/100)] + " Hundred" + (num%100 ? " " + convert(num%100) : "");
                if(num < 100000) return convert(Math.floor(num/1000)) + " Thousand" + (num%1000 ? " " + convert(num%1000) : "");
                if(num < 10000000) return convert(Math.floor(num/100000)) + " Lakh" + (num%100000 ? " " + convert(num%100000) : "");
                return convert(Math.floor(num/10000000)) + " Crore" + (num%10000000 ? " " + convert(num%10000000) : "");
            };
            return convert(Math.round(n)) + " Rupees Only";
        }

        function generateId(t, d, s) {
            const dateObj = d ? new Date(d) : new Date();
            const q = Math.ceil((dateObj.getMonth()+1)/3);
            const prefix = t === 'INVOICE' ? 'INV' : 'QTN';
            const suffix = s || Math.floor(Math.random()*9000+1000);
            return `${prefix}-Q${q}-${suffix}`;
        }

        function initData() {
            const d = new Date().toISOString().split('T')[0];
            return {
                type: 'INVOICE', docId: generateId('INVOICE', d), date: d, dueDate: calcDue(d),
                from: { name: '', address: '', gst: '', pan: '' },
                client: { name: '', address: '', gst: '', pan: '' }, 
                items: [{ desc: '', qty: 1, rate: 0, details: '' }],
                bank: { bankName: '', accountNo: '', ifsc: '', branch: '' },
                taxRate: 18, notes: 'Payment is due within 7 days.', logo: { src: null, size: 100 }, sig: { src: null, size: 100 },
                design: { color: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)', font: 'font-modern' }
            };
        }

        // --- Core Functions ---
        window.updateField = function(k, v) {
            if(k.includes('.')) { 
                const parts = k.split('.');
                data[parts[0]][parts[1]] = v;
            } else {
                data[k] = (k === 'taxRate') ? parseFloat(v || 0) : v;
            }

            if(k === 'date') {
                data.dueDate = calcDue(v);
                data.docId = generateId(data.type, v, data.docId.split('-').pop());
                const el = document.getElementById('document-id');
                if(el) el.value = data.docId;
            }
            renderPreview();
        };

        window.setDocType = function(t) {
            data.type = t;
            const s = data.docId.split('-').pop();
            data.docId = generateId(t, data.date, s);
            const el = document.getElementById('document-id');
            if(el) el.value = data.docId;
            renderPreview();
        };

        window.updateDesign = function(k, v) { 
            data.design[k] = v; 
            renderPreview(); 
        };

        window.addItem = function() { 
            data.items.push({desc:'', qty:1, rate:0, details:''}); 
            renderEditorItems(); 
            renderPreview(); 
        };

        window.deleteItem = function(i) { 
            data.items.splice(i, 1); 
            renderEditorItems(); 
            renderPreview(); 
        };

        window.updateItem = function(i, k, v) {
            if(k === 'qty' || k === 'rate') data.items[i][k] = parseFloat(v || 0);
            else data.items[i][k] = v;
            renderPreview();
        };

        window.handleImageUpload = function(el, type) { 
            const f = el.files[0]; 
            if(f) { 
                const r = new FileReader(); 
                r.onload = e => { 
                    data[type].src = e.target.result; 
                    document.getElementById(`btn-remove-${type}`).classList.remove('hidden');
                    renderPreview(); 
                }; 
                r.readAsDataURL(f); 
            } 
        };

        window.removeImage = function(type) {
            data[type].src = null;
            document.getElementById(`${type}-upload`).value = '';
            document.getElementById(`btn-remove-${type}`).classList.add('hidden');
            renderPreview();
        };

        window.updateImageSize = function(type, v) { 
            data[type].size = v; 
            const el = document.getElementById(`lbl-${type}-size`); 
            if(el) el.innerText = v+'%'; 
            renderPreview(); 
        };

        window.formatText = function(c) { document.execCommand(c, false, null); };

        function renderEditorItems() {
            const list = document.getElementById('editor-items-list');
            if(!list) return;
            list.innerHTML = data.items.map((item, i) => `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3 relative group">
                    <button onclick="deleteItem(${i})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold">×</button>
                    <input type="text" list="item-suggestions" class="w-full bg-transparent border-b border-slate-200 text-sm font-bold p-1 outline-none" value="${item.desc}" placeholder="Item Description" oninput="updateItem(${i}, 'desc', this.value)">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Quantity</span>
                            <input type="number" class="w-full bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-xs font-bold" value="${item.qty}" oninput="updateItem(${i}, 'qty', this.value)">
                        </div>
                        <div class="space-y-1">
                            <span class="text-[9px] text-slate-400 font-bold uppercase">Rate</span>
                            <input type="number" class="w-full bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-xs font-bold" value="${item.rate}" oninput="updateItem(${i}, 'rate', this.value)">
                        </div>
                    </div>
                    <div>
                        <div class="editor-toolbar flex gap-1 mb-1 opacity-40 hover:opacity-100">
                            <button onclick="formatText('bold')" class="text-[9px] bg-white border px-2 py-0.5 rounded font-bold">B</button>
                            <button onclick="formatText('insertUnorderedList')" class="text-[9px] bg-white border px-2 py-0.5 rounded font-bold">• List</button>
                        </div>
                        <div contenteditable="true" class="text-xs bg-white border border-slate-200 rounded-lg p-3 outline-none min-h-[50px] rich-text-editor" oninput="updateItem(${i}, 'details', this.innerHTML)">${item.details}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderPreview() {
            const docEl = document.getElementById('document-preview');
            if(!docEl) return;
            docEl.className = `document-container shadow-2xl relative transition-all duration-300 transform-gpu lg:scale-90 xl:scale-100 origin-top ${data.design.font}`;
            
            // Themes
            document.querySelectorAll('.gradient-accent').forEach(el => el.style.background = data.design.color);
            document.querySelectorAll('.theme-accent-text').forEach(el => el.style.color = (data.design.color.includes('linear') ? data.design.color.split(',')[1].split(' ')[1] : data.design.color));

            const setTxt = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text || ''; };
            setTxt('p-doc-title', data.type);
            setTxt('p-doc-id', data.docId);
            setTxt('p-date', formatDate(data.date));
            setTxt('p-due-date', formatDate(data.dueDate));
            setTxt('p-from-name', data.from.name || 'YOUR BUSINESS NAME');
            setTxt('p-from-address', data.from.address);
            setTxt('p-from-gst', data.from.gst);
            setTxt('p-from-pan', data.from.pan);
            setTxt('p-client-name', data.client.name || 'CLIENT NAME');
            setTxt('p-client-address', data.client.address);
            setTxt('p-client-gst', data.client.gst);
            setTxt('p-client-pan', data.client.pan);
            setTxt('p-notes', data.notes);
            setTxt('p-bank-name', data.bank.bankName);
            setTxt('p-bank-acc', data.bank.accountNo);
            setTxt('p-bank-ifsc', data.bank.ifsc);
            setTxt('p-bank-branch', data.bank.branch);

            // Tab Styles
            const bI = document.getElementById('btn-invoice');
            const bQ = document.getElementById('btn-quote');
            if(bI) bI.className = `py-2.5 text-xs font-black rounded-lg transition-all ${data.type === 'INVOICE' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:bg-slate-200'}`;
            if(bQ) bQ.className = `py-2.5 text-xs font-black rounded-lg transition-all ${data.type === 'QUOTATION' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:bg-slate-200'}`;

            // Branding
            if(data.logo.src) {
                const img = document.getElementById('p-logo-img');
                const ph = document.getElementById('p-logo-placeholder');
                const cont = document.getElementById('p-logo-container');
                if(img) { img.src = data.logo.src; img.classList.remove('hidden'); }
                if(ph) ph.classList.add('hidden');
                if(cont) {
                    const s = 5 * (data.logo.size / 100);
                    cont.style.width = s + 'rem';
                    cont.style.height = s + 'rem';
                }
            } else {
                document.getElementById('p-logo-img').classList.add('hidden');
                document.getElementById('p-logo-placeholder').classList.remove('hidden');
            }

            if(data.sig.src) {
                const img = document.getElementById('p-sig-img');
                if(img) {
                    img.src = data.sig.src;
                    img.classList.remove('hidden');
                    img.style.height = (5 * (data.sig.size/100)) + 'rem';
                }
            } else {
                document.getElementById('p-sig-img').classList.add('hidden');
            }

            let sub = 0;
            const tbody = document.getElementById('p-items-body');
            if(tbody) {
                tbody.innerHTML = data.items.map(item => {
                    const tot = (item.qty || 0) * (item.rate || 0);
                    sub += tot;
                    return `<tr class="border-b border-slate-50 align-top page-break-avoid"><td class="py-5 px-6"><div class="font-bold text-slate-800 mb-1">${item.desc||'New Item'}</div><div class="text-[10px] text-slate-500 rich-content">${item.details}</div></td><td class="py-5 px-6 text-center font-bold">${item.qty}</td><td class="py-5 px-6 text-right font-medium">${formatMoney(item.rate)}</td><td class="py-5 px-6 text-right font-black text-slate-900">${formatMoney(tot)}</td></tr>`;
                }).join('');
            }

            const tax = sub * (data.taxRate/100);
            const total = Math.round(sub + tax);
            setTxt('p-subtotal', formatMoney(sub));
            setTxt('p-tax-label', data.taxRate);
            setTxt('p-tax-amount', formatMoney(tax));
            setTxt('p-total', formatMoney(total));
            setTxt('p-amount-words', numToWords(total));
        }

        // --- PDF Generation with Zero Margins ---
        window.downloadPDF = function() {
            document.body.classList.add('generating-pdf');
            const el = document.getElementById('document-preview');
            const opt = { 
                margin: 0, 
                filename: `${data.docId}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 3, useCORS: true, width: 794 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            html2pdf().set(opt).from(el).save().then(() => {
                document.body.classList.remove('generating-pdf');
            });
        };

        // --- Save Profile Feature (Supabase) ---
        window.saveProfile = async function(section) {
            if(!userId || !supabaseClient) return alert('Please log in to save profiles');
            try {
                const profileData = section === 'bank' ? data.bank : 
                                   section === 'from' ? data.from : 
                                   data.client;
                
                const { error } = await supabaseClient
                    .from('invoice_profiles')
                    .upsert({
                        user_id: userId,
                        profile_type: section,
                        profile_data: profileData,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,profile_type'
                    });
                
                if (error) throw error;
                alert(`${section.toUpperCase()} profile saved as default!`);
            } catch(e) { 
                console.error('Save profile error:', e);
                alert('Failed to save profile'); 
            }
        };

        window.saveDocument = async function() {
            if(!userId || !supabaseClient) return alert('Please log in to save documents');
            try {
                const payload = {
                    user_id: userId,
                    doc_id: data.docId,
                    doc_type: data.type,
                    doc_date: data.date,
                    due_date: data.dueDate || null,
                    from_name: data.from.name,
                    from_address: data.from.address,
                    from_gst: data.from.gst,
                    from_pan: data.from.pan,
                    client_name: data.client.name,
                    client_address: data.client.address,
                    client_gst: data.client.gst,
                    client_pan: data.client.pan,
                    items: data.items,
                    bank_name: data.bank.bankName,
                    bank_account_no: data.bank.accountNo,
                    bank_ifsc: data.bank.ifsc,
                    bank_branch: data.bank.branch,
                    tax_rate: data.taxRate,
                    notes: data.notes,
                    logo_src: data.logo.src,
                    logo_size: data.logo.size,
                    sig_src: data.sig.src,
                    sig_size: data.sig.size,
                    design_color: data.design.color,
                    design_font: data.design.font
                };

                if(currentId) {
                    const { error } = await supabaseClient
                        .from('invoices')
                        .update(payload)
                        .eq('id', currentId);
                    if (error) throw error;
                } else {
                    const { data: newDoc, error } = await supabaseClient
                        .from('invoices')
                        .insert(payload)
                        .select()
                        .single();
                    if (error) throw error;
                    currentId = newDoc.id;
                }
                alert('Saved to Archive');
                loadHistory();
            } catch(e) { 
                console.error('Save error:', e);
                alert('Save Failed: ' + e.message); 
            }
        };

        window.resetDocument = function() { 
            if(confirm('Reset all details?')) { 
                data = initData(); 
                currentId = null; 
                initForm(); 
                renderPreview(); 
            } 
        };

        window.loadDoc = function(id) {
            const doc = historyDocs.find(x => x.id === id);
            if(doc) {
                data = {
                    type: doc.doc_type,
                    docId: doc.doc_id,
                    date: doc.doc_date,
                    dueDate: doc.due_date,
                    from: {
                        name: doc.from_name || '',
                        address: doc.from_address || '',
                        gst: doc.from_gst || '',
                        pan: doc.from_pan || ''
                    },
                    client: {
                        name: doc.client_name || '',
                        address: doc.client_address || '',
                        gst: doc.client_gst || '',
                        pan: doc.client_pan || ''
                    },
                    items: doc.items || [],
                    bank: {
                        bankName: doc.bank_name || '',
                        accountNo: doc.bank_account_no || '',
                        ifsc: doc.bank_ifsc || '',
                        branch: doc.bank_branch || ''
                    },
                    taxRate: doc.tax_rate || 18,
                    notes: doc.notes || '',
                    logo: { src: doc.logo_src, size: doc.logo_size || 100 },
                    sig: { src: doc.sig_src, size: doc.sig_size || 100 },
                    design: {
                        color: doc.design_color || 'linear-gradient(135deg, #1e293b 0%, #334155 100%)',
                        font: doc.design_font || 'font-modern'
                    }
                };
                currentId = id;
                initForm();
                renderPreview();
            }
        };

        window.deleteDoc = async function(id, e) {
            e.stopPropagation();
            if(!confirm('Delete this document?')) return;
            try {
                const { error } = await supabaseClient
                    .from('invoices')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                if (currentId === id) {
                    currentId = null;
                    data = initData();
                    initForm();
                    renderPreview();
                }
                loadHistory();
            } catch(e) {
                console.error('Delete error:', e);
                alert('Failed to delete');
            }
        };

        function initForm() {
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
            safeSet('document-id', data.docId);
            safeSet('input-date', data.date);
            safeSet('input-tax', data.taxRate);
            safeSet('input-notes', data.notes);
            safeSet('from-name', data.from.name);
            safeSet('from-address', data.from.address);
            safeSet('from-gst', data.from.gst);
            safeSet('from-pan', data.from.pan);
            safeSet('client-name', data.client.name);
            safeSet('client-address', data.client.address);
            safeSet('client-gst', data.client.gst);
            safeSet('client-pan', data.client.pan);
            safeSet('bank-name', data.bank.bankName);
            safeSet('bank-acc', data.bank.accountNo);
            safeSet('bank-ifsc', data.bank.ifsc);
            safeSet('bank-branch', data.bank.branch);
            
            // Handle image buttons visibility
            if(data.logo.src) {
                document.getElementById('btn-remove-logo').classList.remove('hidden');
            }
            if(data.sig.src) {
                document.getElementById('btn-remove-sig').classList.remove('hidden');
            }
            
            renderEditorItems();
        }

        async function loadHistory() {
            if(!userId || !supabaseClient) return;
            try {
                const { data: docs, error } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .eq('user_id', userId)
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                historyDocs = docs || [];
                const l = document.getElementById('history-list');
                if(!l) return;
                
                if(!historyDocs.length) { 
                    l.innerHTML = '<li class="p-4 text-center italic text-[10px] text-slate-400 bg-slate-50 rounded-xl">Empty Archive</li>'; 
                    return; 
                }
                
                l.innerHTML = historyDocs.map(x => `
                    <li onclick="loadDoc('${x.id}')" class="p-3 bg-white border border-slate-100 rounded-xl hover:border-slate-300 cursor-pointer shadow-sm transition-all relative group">
                        <button onclick="deleteDoc('${x.id}', event)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity font-bold text-xs">×</button>
                        <div class="flex justify-between text-[10px] font-black uppercase tracking-tighter">
                            <span>${x.doc_type}</span>
                            <span class="text-slate-300">${x.doc_date}</span>
                        </div>
                        <div class="truncate text-[11px] font-mono font-bold mt-1 text-slate-500">${x.doc_id}</div>
                        <div class="truncate text-[10px] text-slate-400 mt-1">${x.client_name || 'No client'}</div>
                    </li>
                `).join('');
            } catch(e) {
                console.error('Load history error:', e);
            }
        }

        async function loadProfiles() {
            if(!userId || !supabaseClient) return;
            try {
                const { data: profiles, error } = await supabaseClient
                    .from('invoice_profiles')
                    .select('*')
                    .eq('user_id', userId);
                
                if (error) throw error;
                
                for(const profile of (profiles || [])) {
                    if(profile.profile_type === 'from') {
                        data.from = profile.profile_data;
                    } else if(profile.profile_type === 'bank') {
                        data.bank = profile.profile_data;
                    }
                }
                initForm();
                renderPreview();
            } catch(e) {
                console.error('Load profiles error:', e);
            }
        }

        async function initSupabase() {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        storage: localStorage,
                        persistSession: true,
                        autoRefreshToken: true
                    }
                });

                // Check for existing session
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if(session?.user) {
                    userId = session.user.id;
                    document.getElementById('auth-indicator').className = 'w-2.5 h-2.5 rounded-full bg-green-400 shadow-sm shadow-green-200';
                    document.getElementById('auth-indicator').title = 'Cloud Sync Active';
                    
                    // Show user name if available
                    const nameEl = document.getElementById('user-name');
                    if(nameEl && session.user.email) {
                        nameEl.textContent = session.user.email.split('@')[0];
                        nameEl.classList.remove('hidden');
                    }
                    
                    await loadProfiles();
                    await loadHistory();
                } else {
                    document.getElementById('auth-indicator').title = 'Not logged in - data will not be saved';
                    document.getElementById('history-list').innerHTML = '<li class="p-4 text-center italic text-[10px] text-slate-400 bg-slate-50 rounded-xl">Log in to the main app to access cloud archive</li>';
                }

                // Listen for auth changes
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if(session?.user) {
                        userId = session.user.id;
                        document.getElementById('auth-indicator').className = 'w-2.5 h-2.5 rounded-full bg-green-400 shadow-sm shadow-green-200';
                        document.getElementById('auth-indicator').title = 'Cloud Sync Active';
                        
                        const nameEl = document.getElementById('user-name');
                        if(nameEl && session.user.email) {
                            nameEl.textContent = session.user.email.split('@')[0];
                            nameEl.classList.remove('hidden');
                        }
                        
                        setTimeout(async () => {
                            await loadProfiles();
                            await loadHistory();
                        }, 0);
                    } else {
                        userId = null;
                        document.getElementById('auth-indicator').className = 'w-2.5 h-2.5 rounded-full bg-red-400 shadow-sm';
                        document.getElementById('auth-indicator').title = 'Not logged in';
                        document.getElementById('user-name').classList.add('hidden');
                        document.getElementById('history-list').innerHTML = '<li class="p-4 text-center italic text-[10px] text-slate-400 bg-slate-50 rounded-xl">Log in to the main app to access cloud archive</li>';
                    }
                });

            } catch(e) {
                console.error('Supabase init error:', e);
            }
        }

        window.onload = function() { 
            initSupabase(); 
            initForm(); 
            renderPreview(); 
        };
    </script>
</body>
</html>